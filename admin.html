<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Cockpit • RamFinder</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">RF</div>
      <div style="flex:1">
        <h1>Admin Cockpit</h1>
        <div class="subtitle">Manage admin emails, resources, and announcements.</div>
        <nav class="breadcrumb"><a href="index.html">Home</a> › <span>Admin</span></nav>
      </div>
      <div id="userbox" class="badge">Guest</div>
      <a id="favLink" class="btn" href="favorites.html" style="display:none">Favorites</a>
      <a id="loginLink" class="btn" href="login.html">Log in</a>
      <button id="logoutBtn" class="btn" style="display:none">Log out</button>
      <a id="adminLink" class="btn" href="admin.html" style="display:none">Admin</a>
    </header>

    <div class="controls" style="gap:8px; flex-wrap:wrap">
      <button id="tabAdmins" class="chip" aria-pressed="true">Admins</button>
      <button id="tabResources" class="chip" aria-pressed="false">Resources</button>
      <span id="apiStatus" class="badge" style="margin-left:auto">Checking backend…</span>
    </div>

    <!-- Admins Panel -->
    <section id="panelAdmins" class="card">
      <div class="subtitle" style="margin-bottom:10px">
        Enter an email address and click Add Admin to add a new administrator.
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
        <input id="adminEmail" type="email" placeholder="new-admin@colostate.edu"
               style="flex:1; padding:10px;" />
        <button id="addAdminBtn" class="btn">Add Admin</button>
      </div>

      <table class="table">
        <thead><tr><th>Email</th><th style="width:160px">Actions</th></tr></thead>
        <tbody id="adminRows"></tbody>
      </table>
    </section>

    <!-- Resources Panel -->
    <section id="panelResources" class="card" style="display:none">
      <div class="subtitle" style="margin-bottom:10px">
        Manage campus resources, including out-of-service status and announcements.
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px">
        <input id="resSearch" type="search" placeholder="Filter by name, type, building"
               style="flex:1; padding:8px;" />
        <button id="addResBtn" class="btn">New Resource</button>
      </div>

      <table class="table">
        <thead><tr>
          <th>ID</th><th>Name</th><th>Type</th><th>Building</th><th>Room</th><th>Status</th><th style="width:200px">Actions</th>
        </tr></thead>
        <tbody id="resRows"></tbody>
      </table>

      <!-- Inline form -->
      <div id="resFormWrap" class="card" style="margin-top:16px; display:none">
        <h3 id="resFormTitle">New Resource</h3>
        <div id="resFormAlert" class="subtitle" style="color:#fca5a5; display:none;"></div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px">
          <div><label>Name</label><input id="f_name" type="text" /></div>
          <div><label>Type</label><input id="f_type" type="text" placeholder="printer, vending, study, lab, restroom"/></div>
          <div><label>Building</label><input id="f_building" type="text" /></div>
          <div><label>Room</label><input id="f_room" type="text" /></div>
          <div style="grid-column:1/-1"><label>Notes</label><textarea id="f_notes" rows="2"></textarea></div>
        </div>

        <div style="margin-top:8px;">
          <label class="toggle">
            <input id="f_out_of_service" type="checkbox" />
            Mark this resource as Out of Service
          </label>
        </div>

        <h4 style="margin-top:14px">Weekly Hours</h4>
        <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px" id="hoursGrid"></div>

        <div class="actions" style="margin-top:14px">
          <button id="saveResBtn" class="btn">Save</button>
          <button id="cancelResBtn" class="btn">Cancel</button>
        </div>
      </div>

      <!-- Announcements Panel -->
      <section id="panelAnnouncements" class="card" style="margin-top:16px;">
        <h2>Announcements</h2>
        <div class="subtitle" style="margin-bottom:10px">
          Post short updates that you will email to subscribers.
          These are also visible on the RamFinder home page.
        </div>

        <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:12px">
          <input id="annTitle" type="text" placeholder="Announcement title" />
          <textarea id="annBody" rows="3" placeholder="Announcement body"></textarea>
        </div>
        <div class="actions" style="margin-bottom:12px">
          <button id="annPostBtn" class="btn">Post announcement</button>
          <span id="annStatus" class="meta" aria-live="polite"></span>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Created</th>
              <th>By</th>
              <th style="width:120px">Actions</th>
            </tr>
          </thead>
          <tbody id="annRows"></tbody>
        </table>
      </section>
    </section>
  </div>

  <script src="assets/auth.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    const API_BASE = 'http://127.0.0.1:5050';
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    (function initHeader(){
      const sess = AUTH.current();
      const userbox   = document.getElementById('userbox');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const adminLink = document.getElementById('adminLink');
      const favLink   = document.getElementById('favLink');

      if (sess) {
        userbox.textContent = (sess.admin ? 'Admin • ' : '') + (sess.email || '');
        loginLink.style.display = 'none';
        logoutBtn.style.display  = 'inline-block';
        favLink.style.display    = 'inline-block';
        logoutBtn.addEventListener('click', () => {
          AUTH.logout();
          window.location.href = 'index.html';
        });
        if (sess.admin && adminLink) adminLink.style.display = 'inline-block';
        else if (adminLink) adminLink.style.display = 'none';
      } else {
        userbox.textContent = 'Guest';
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display  = 'none';
        favLink.style.display    = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    })();
  </script>

  <script>
    (async function(){
      const sess = AUTH.current();
      const apiBadge = document.getElementById('apiStatus');

      async function apiFetch(path, options = {}){
        const headers = options.headers || {};
        if (sess && sess.email){
          headers['X-User-Email'] = sess.email;
        }
        headers['Content-Type'] = headers['Content-Type'] || 'application/json';
        const res = await fetch(`${API_BASE}${path}`, {...options, headers});
        return res;
      }

      async function setApiBadge(){
        try{
          const r = await fetch(`${API_BASE}/api/health`, {cache:'no-store'});
          const j = await r.json();
          const up = !!j.ok;
          apiBadge.textContent = up ? 'Backend: online' : 'Backend: offline';
          apiBadge.style.borderColor = up ? '#34d399' : '#fca5a5';
          apiBadge.style.color = up ? '#34d399' : '#fca5a5';
          return up;
        }catch{
          apiBadge.textContent = 'Backend: offline';
          apiBadge.style.borderColor = '#fca5a5';
          apiBadge.style.color = '#fca5a5';
          return False;
        }
      }
      let apiUp = await setApiBadge();

      const tabAdmins = document.getElementById('tabAdmins');
      const tabResources = document.getElementById('tabResources');
      const panelAdmins = document.getElementById('panelAdmins');
      const panelResources = document.getElementById('panelResources');
      function selectTab(which){
        const isAdmins = which === 'admins';
        tabAdmins.setAttribute('aria-pressed', isAdmins ? 'true' : 'false');
        tabResources.setAttribute('aria-pressed', !isAdmins ? 'true' : 'false');
        panelAdmins.style.display = isAdmins ? '' : 'none';
        panelResources.style.display = !isAdmins ? '' : 'none';
      }
      tabAdmins.addEventListener('click', ()=> selectTab('admins'));
      tabResources.addEventListener('click', ()=> selectTab('resources'));

      const adminEmail = document.getElementById('adminEmail');
      const addAdminBtn = document.getElementById('addAdminBtn');
      const adminRows = document.getElementById('adminRows');

      async function loadAdmins(){
        adminRows.innerHTML = '';
        const res = await fetch(`${API_BASE}/api/admins`, {cache:'no-store'});
        const data = await res.json();
        (data || []).forEach(email => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${email}</td>
            <td>
              <button class="btn" data-email="${email}">Remove</button>
            </td>`;
          adminRows.appendChild(tr);
        });
      }

      addAdminBtn.addEventListener('click', async () => {
        const email = (adminEmail.value || '').trim();
        if (!email){ return; }
        const res = await apiFetch('/api/admins', {
          method:'POST',
          body: JSON.stringify({email})
        });
        if (!res.ok){
          alert('Could not add admin (check backend log).');
          return;
        }
        adminEmail.value = '';
        loadAdmins();
      });

      adminRows.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-email]');
        if (!btn) return;
        if (!confirm('Remove this admin?')) return;
        const email = btn.getAttribute('data-email');
        const res = await apiFetch('/api/admins', {
          method:'DELETE',
          body: JSON.stringify({email})
        });
        if (!res.ok){
          alert('Could not remove admin.');
          return;
        }
        loadAdmins();
      });

      let RES_ALL = [];
      const resRows = document.getElementById('resRows');
      const resSearch = document.getElementById('resSearch');
      const resFormWrap = document.getElementById('resFormWrap');
      const resFormTitle = document.getElementById('resFormTitle');
      const resFormAlert = document.getElementById('resFormAlert');
      const f_name = document.getElementById('f_name');
      const f_type = document.getElementById('f_type');
      const f_building = document.getElementById('f_building');
      const f_room = document.getElementById('f_room');
      const f_notes = document.getElementById('f_notes');
      const f_out_of_service = document.getElementById('f_out_of_service');
      const hoursGrid = document.getElementById('hoursGrid');
      const saveResBtn = document.getElementById('saveResBtn');
      const cancelResBtn = document.getElementById('cancelResBtn');
      let EDITING_ID = null;

      function isOpenNow(item, now=new Date()){
        if (!item.hours) return False;
        const slot = item.hours[DOW[now.getDay()]];
        if (!slot || slot.closed) return False;
        const [oh,om] = (slot.open||'00:00').split(':').map(Number);
        const [ch,cm] = (slot.close||'00:00').split(':').map(Number);
        const cur = now.getHours()*60 + now.getMinutes();
        const openM = oh*60+om, closeM = ch*60+cm;
        return cur >= openM && cur <= closeM;
      }

      function populateHoursGrid(hours){
        hoursGrid.innerHTML = DOW.map(d => {
          const v = hours?.[d] || {};
          const closed = !!v.closed, open=v.open||'08:00', close=v.close||'17:00';
          return `
            <div class="card" data-day="${d}" style="padding:10px">
              <div style="font-weight:600; margin-bottom:4px">${d}</div>
              <label class="toggle"><input type="checkbox" class="h_closed" ${closed?'checked':''}/> Closed</label>
              <div style="display:flex; gap:6px; margin-top:6px">
                <input type="time" class="h_open" value="${open}" ${closed?'disabled':''}/>
                <span style="align-self:center">to</span>
                <input type="time" class="h_close" value="${close}" ${closed?'disabled':''}/>
              </div>
            </div>`;
        }).join('');
        hoursGrid.querySelectorAll('.h_closed').forEach(ch => {
          ch.addEventListener('change', () => {
            const card = ch.closest('.card');
            const openEl = card.querySelector('.h_open');
            const closeEl = card.querySelector('.h_close');
            const closed = ch.checked;
            openEl.disabled = closed;
            closeEl.disabled = closed;
          });
        });
      }

      function buildHoursFromGrid(){
        const out = {};
        hoursGrid.querySelectorAll('.card').forEach(card => {
          const day = card.getAttribute('data-day');
          const closed = card.querySelector('.h_closed').checked;
          const openEl = card.querySelector('.h_open');
          const closeEl = card.querySelector('.h_close');
          out[day] = {
            closed,
            open: openEl.value || '00:00',
            close: closeEl.value || '00:00'
          };
        });
        return out;
      }

      function filterList(q){
        const n = (q||'').toLowerCase();
        if (!n) return RES_ALL;
        return RES_ALL.filter(r => {
          const hay = [r.name,r.type,r.building,r.room].map(x=>(x||'').toLowerCase()).join(' ');
          return hay.includes(n);
        });
      }

      function renderResources(){
        resRows.innerHTML = '';
        const list = filterList(resSearch.value).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        for(const r of list){
          const openNow = isOpenNow(r);
          const out = !!r.out_of_service;
          const statusClass = out ? 'closed' : (openNow ? 'open' : 'closed');
          const statusText  = out ? 'Out of Service' : (openNow ? 'Open' : 'Closed');

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.name}</td>
            <td>${r.type}</td>
            <td>${r.building}</td>
            <td>${r.room || ''}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>
              <button class="btn" data-action="edit" data-id="${r.id}" ${apiUp?'':'disabled title="Backend offline"'}>Edit</button>
              <button class="btn" data-action="del" data-id="${r.id}" ${apiUp?'':'disabled title="Backend offline"'}>Delete</button>
            </td>`;
          resRows.appendChild(tr);
        }
      }

      async function loadResources(){
        const res = await fetch(`${API_BASE}/api/resources`, {cache:'no-store'});
        RES_ALL = await res.json();
        renderResources();
      }

      function openForm(rec){
        resFormAlert.style.display = 'none';
        resFormAlert.textContent = '';
        if(rec){
          EDITING_ID = rec.id;
          resFormTitle.textContent = `Edit Resource #${rec.id}`;
          f_name.value = rec.name || '';
          f_type.value = rec.type || '';
          f_building.value = rec.building || '';
          f_room.value = rec.room || '';
          f_notes.value = rec.notes || '';
          f_out_of_service.checked = !!rec.out_of_service;
          populateHoursGrid(rec.hours);
        }else{
          EDITING_ID = null;
          resFormTitle.textContent = 'New Resource';
          f_name.value = f_type.value = f_building.value = f_room.value = f_notes.value = '';
          f_out_of_service.checked = false;
          populateHoursGrid(null);
        }
        resFormWrap.style.display = '';
      }

      function closeForm(){
        resFormWrap.style.display = 'none';
      }

      document.getElementById('addResBtn').addEventListener('click', ()=>{
        if(!apiUp){ alert('Backend offline. Start with: python app.py'); return; }
        openForm(null);
      });
      resSearch.addEventListener('input', renderResources);

      resRows.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const rec = RES_ALL.find(r => String(r.id) === String(id));
        if (action === 'edit'){
          openForm(rec);
        } else if (action === 'del'){
          if (!confirm('Delete this resource?')) return;
          const res = await apiFetch(`/api/resources/${encodeURIComponent(id)}`, {
            method:'DELETE'
          });
          if (!res.ok){
            alert('Could not delete resource.');
            return;
          }
          loadResources();
        }
      });

      cancelResBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        closeForm();
      });

      saveResBtn.addEventListener('click', async (e)=>{
        e.preventDefault();
        resFormAlert.style.display = 'none';
        resFormAlert.textContent = '';

        const name = f_name.value.trim();
        const type = f_type.value.trim();
        const building = f_building.value.trim();

        if (!name || !type || !building){
          resFormAlert.textContent = 'Name, Type, and Building are required.';
          resFormAlert.style.display = 'block';
          return;
        }

        const payload = {
          name, type, building,
          room: f_room.value.trim(),
          notes: f_notes.value,
          hours: buildHoursFromGrid(),
          out_of_service: !!f_out_of_service.checked
        };

        let res;
        if (EDITING_ID){
          res = await apiFetch(`/api/resources/${encodeURIComponent(EDITING_ID)}`, {
            method:'PUT',
            body: JSON.stringify(payload)
          });
        } else {
          res = await apiFetch(`/api/resources`, {
            method:'POST',
            body: JSON.stringify(payload)
          });
        }
        if (!res.ok){
          resFormAlert.textContent = 'Could not save resource. See backend log.';
          resFormAlert.style.display = 'block';
          return;
        }
        closeForm();
        loadResources();
      });

      // --- Announcements ---
      const annTitle  = document.getElementById('annTitle');
      const annBody   = document.getElementById('annBody');
      const annPostBtn= document.getElementById('annPostBtn');
      const annStatus = document.getElementById('annStatus');
      const annRows   = document.getElementById('annRows');

      async function loadAnnouncements(){
        annRows.innerHTML = '';
        try {
          const res = await fetch(`${API_BASE}/api/announcements`, {cache:'no-store'});
          const anns = await res.json();
          (anns || []).forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${a.title}</td>
              <td>${a.created_at || ''}</td>
              <td>${a.created_by || ''}</td>
              <td>
                <button class="btn" data-ann-id="${a.id}">Delete</button>
              </td>`;
            annRows.appendChild(tr);
          });
        } catch (err){
          console.error(err);
          annStatus.textContent = 'Could not load announcements.';
        }
      }

      annPostBtn.addEventListener('click', async () => {
        annStatus.textContent = '';
        const title = (annTitle.value || '').trim();
        const body  = (annBody.value  || '').trim();
        if (!title || !body){
          annStatus.textContent = 'Title and body are required.';
          return;
        }
        try {
          const res = await apiFetch('/api/announcements', {
            method: 'POST',
            body: JSON.stringify({ title, body })
          });
          const data = await res.json();
          if (!res.ok || data.error){
            annStatus.textContent = data.error || 'Could not post announcement.';
            return;
          }
          annTitle.value = '';
          annBody.value  = '';
          annStatus.textContent = 'Announcement posted.';
          loadAnnouncements();
        } catch (err){
          console.error(err);
          annStatus.textContent = 'Server error posting announcement.';
        }
      });

      annRows.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-ann-id]');
        if (!btn) return;
        if (!confirm('Delete this announcement?')) return;
        const id = btn.getAttribute('data-ann-id');
        try {
          const res = await apiFetch(`/api/announcements/${encodeURIComponent(id)}`, {
            method: 'DELETE'
          });
          const data = await res.json();
          if (!res.ok || data.error){
            alert(data.error || 'Could not delete announcement.');
            return;
          }
          loadAnnouncements();
        } catch (err){
          console.error(err);
          alert('Server error deleting announcement.');
        }
      });

      // Init
      await loadAdmins();
      await loadResources();
      await loadAnnouncements();

      function requireAdmin(){
        if (!sess || !sess.admin){
          alert('You must be an admin to use this page.');
        }
      }
      requireAdmin();
    })();
  </script>
</body>
</html>
