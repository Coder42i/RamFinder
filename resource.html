<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resource Details • RamFinder</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">RF</div>
      <div style="flex:1">
        <h1 id="title">Resource</h1>
        <div class="subtitle">Details and directions.</div>
        <nav class="breadcrumb"><a href="index.html">Home</a> › <span>Details</span></nav>
      </div>
      <div id="userbox" class="badge"></div>
      <a id="loginLink" class="btn" href="login.html" style="width:auto">Log in</a>
      <button id="logoutBtn" class="btn" style="width:auto; display:none">Log out</button>
      <a id="adminLink" class="btn" href="admin.html" style="width:auto; display:none">Admin</a>
    </header>

    <section class="card" id="details"></section>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/auth.js"></script>
  <script>
    (async function initHeader(){
      const sess = AUTH.current();
      const userbox   = document.getElementById('userbox');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const adminLink = document.getElementById('adminLink');
      if (sess) {
        userbox.textContent = (sess.admin ? 'Admin • ' : '') + (sess.email || '');
        loginLink.style.display = 'none';
        logoutBtn.style.display  = 'inline-block';
        logoutBtn.addEventListener('click', () => { AUTH.logout(); window.location.href = 'index.html'; });
        if (sess.admin && adminLink) adminLink.style.display = 'inline-block'; else if (adminLink) adminLink.style.display = 'none';
      } else {
        userbox.textContent = 'Guest';
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display  = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    })();
  </script>
  <script>
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    function isOpenNow(item, now=new Date()){
      const slot = item.hours[DOW[now.getDay()]];
      if(!slot || slot.closed) return false;
      const [oh, om] = (slot.open||'00:00').split(':').map(Number);
      const [ch, cm] = (slot.close||'00:00').split(':').map(Number);
      const openM = oh*60+om, closeM = ch*60+cm, curM = now.getHours()*60+now.getMinutes();
      return curM>=openM && curM<=closeM;
    }
    function esc(s){return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
    function qs(name){const u=new URL(location.href);return u.searchParams.get(name)}
    async function load(){
      const id = qs('id');
      const res = await fetch('data/resources.json', {cache:'no-store'});
      const list = await res.json();
      const item = list.find(r => r.id === id);
      const box = document.getElementById('details');
      const title = document.getElementById('title');
      if(!item){ box.innerHTML = '<div class="empty">Resource not found.</div>'; return; }
      title.textContent = item.name;
      const open = isOpenNow(item);
      const hours = Object.entries(item.hours||{}).map(([d,v])=>{
        if (v && v.closed) return `<tr><td>${d}</td><td>Closed</td></tr>`;
        if (!v) return `<tr><td>${d}</td><td>—</td></tr>`;
        return `<tr><td>${d}</td><td>${esc(v.open)} — ${esc(v.close)}</td></tr>`;
      }).join('');
      const gmap = `https://www.google.com/maps/search/${encodeURIComponent((item.name||'')+' '+(item.building||'')+' Colorado State University')}`;
      box.innerHTML = `
        <div class="badge">${esc(item.type[0].toUpperCase()+item.type.slice(1))}</div>
        <h2 style="margin:0">${esc(item.name)}</h2>
        <div class="row"><span class="dot"></span><span>${esc(item.building)}${item.room?', '+esc(item.room):''}</span></div>
        <div class="row"><strong class="${open?'open':'closed'}">${open?'Open Now':'Closed'}</strong></div>
        <div class="row">${esc(item.notes||'')}</div>
        <div class="actions">
          <a class="btn" href="${gmap}" target="_blank">Directions</a>
          <a class="btn" href="index.html">Back to Search</a>
        </div>
        <div style="height:12px"></div>
        <table class="table"><thead><tr><th>Day</th><th>Hours</th></tr></thead><tbody>${hours}</tbody></table>
      `;
    }
    load();
  </script>
</body>
</html>
