<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RamFinder ‚Ä¢ Resource Details</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">RF</div>
      <div>
        <h1>RamFinder ‚Äì Resource Details</h1>
        <div class="subtitle">See hours, status, location, and actions for this resource.</div>
        <nav class="breadcrumb"><a href="index.html">Home</a> / <span>Details</span></nav>
      </div>
      <div id="userbox" class="badge">Guest</div>
      <a id="favLink" class="btn" href="favorites.html" style="display:none">Favorites</a>
      <a id="loginLink" class="btn" href="login.html">Log in</a>
      <button id="logoutBtn" class="btn" style="display:none">Log out</button>
      <a id="adminLink" class="btn" href="admin.html" style="display:none">Admin</a>
    </header>

    <section id="detail" class="results" aria-live="polite" aria-atomic="true"></section>
    <div id="notfound" class="empty" hidden>That resource wasn‚Äôt found.</div>

    <footer>
      <div>
        Tip: Use ‚ÄúDirections‚Äù to open the location in Google Maps. Sign in to save as a favorite.
      </div>
    </footer>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/favs.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    (function initHeader(){
      const sess = AUTH.current();
      const userbox   = document.getElementById('userbox');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const adminLink = document.getElementById('adminLink');
      const favLink   = document.getElementById('favLink');

      if (sess) {
        userbox.textContent = (sess.admin ? 'Admin ‚Ä¢ ' : '') + (sess.email || '');
        loginLink.style.display = 'none';
        logoutBtn.style.display  = 'inline-block';
        favLink.style.display    = 'inline-block';
        logoutBtn.addEventListener('click', () => {
          AUTH.logout();
          window.location.href = 'index.html';
        });
        if (sess.admin && adminLink) adminLink.style.display = 'inline-block';
        else if (adminLink) adminLink.style.display = 'none';
      } else {
        userbox.textContent = 'Guest';
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display  = 'none';
        favLink.style.display    = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    })();
  </script>

  <script>
    const DATA_URL = 'data/resources.json';
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    const qs = new URLSearchParams(location.search);
    const RESOURCE_ID = (qs.get('id') || '').trim();

    function esc(s){ return (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function isOpenNow(item, now=new Date()){
      if (!item.hours) return false;
      const slot = item.hours[DOW[now.getDay()]];
      if (!slot || slot.closed) return false;
      const [oh,om] = (slot.open||'00:00').split(':').map(Number);
      const [ch,cm] = (slot.close||'00:00').split(':').map(Number);
      const cur = now.getHours()*60 + now.getMinutes();
      const openM = oh*60+om, closeM = ch*60+cm;
      return cur >= openM && cur <= closeM;
    }

    function hoursTable(hours){
      if (!hours) return '';
      const order = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      const rows = order.map(d => {
        const h = hours[d];
        const txt = (!h || h.closed) ? 'Closed' : `${h.open} ‚Äì ${h.close}`;
        return `<tr><th scope="row">${d}</th><td>${esc(txt)}</td></tr>`;
      }).join('');
      return `<table class="table hours"><thead><tr><th>Day</th><th>Hours</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function copyLinkToClipboard(url, message){
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          alert(message || 'Link copied to clipboard.');
        } else {
          window.prompt('Copy this link:', url);
        }
      } catch (e) {
        console.error('Copy failed', e);
        window.prompt('Copy this link:', url);
      }
    }

    async function init(){
      const detail = document.getElementById('detail');
      const notfound = document.getElementById('notfound');
      if (!RESOURCE_ID){
        notfound.hidden = false;
        return;
      }

      const res = await fetch(DATA_URL, {cache:'no-store'});
      const list = await res.json();
      const item = list.find(r => String(r.id) === String(RESOURCE_ID));

      if (!item){
        notfound.hidden = false;
        return;
      }

      const open = isOpenNow(item);
      const out  = !!item.out_of_service;
      const statusClass = out ? 'closed' : (open ? 'open' : 'closed');
      const statusText  = out ? 'Out of Service' : (open ? 'Open Now' : 'Closed');
      const mapQ = encodeURIComponent(item.name+' '+item.building+' Colorado State University');

      const sess = AUTH.current();
      const isFav = !!(sess && FAVS.has(sess.email, item.id));

      detail.innerHTML = `
        <article class="card">
          <div class="badge">${esc(item.type || 'Resource')}</div>
          <h2 class="name">${esc(item.name)}</h2>
          <div class="row">
            <span class="dot"></span>
            <span>${esc(item.building)}${item.room ? ', '+esc(item.room) : ''}</span>
          </div>

          <div class="row" style="margin:.25rem 0 .25rem 0">
            <strong class="${statusClass}">${statusText}</strong>
          </div>

          ${out ? `<p class="closed" style="margin:0 0 .75rem 0; font-weight:600;">
            This resource is currently marked as Out of Service by the RamFinder team.
          </p>` : ''}

          ${item.accessibility
            ? `<p style="margin:.25rem 0 .75rem 0">‚ôø ${esc(item.accessibility)}</p>`
            : ''}

          ${item.notes ? `<p style="margin:.25rem 0 1rem 0">${esc(item.notes)}</p>` : ''}

          <h3>Hours</h3>
          ${hoursTable(item.hours)}

          <div class="actions" style="margin-top:1rem; flex-wrap:wrap; row-gap:6px">
            <a class="btn"
               href="https://www.google.com/maps/search/${mapQ}"
               target="_blank">
              Directions
            </a>

            <button class="btn icon-btn" type="button"
                    id="shareResourceBtn"
                    title="Copy link to this resource"
                    aria-label="Copy link to this resource">üîó</button>

            <button class="btn icon-btn" type="button"
                    id="shareLocationBtn"
                    title="Copy directions link"
                    aria-label="Copy directions link">üìç</button>

            <button class="btn" id="favBtn"
                    data-id="${item.id}"
                    aria-pressed="${isFav?'true':'false'}">
              ${isFav ? '‚òÖ Favorited' : '‚òÜ Favorite'}
            </button>

            <details class="feedback-menu" style="position:relative;">
              <summary
                class="btn"
                title="Report an issue or provide feedback"
                aria-label="Report an issue or provide feedback"
                style="list-style:none; cursor:pointer;">
                Feedback ‚ñæ
              </summary>
              <div
                class="feedback-menu-panel"
                style="position:absolute; z-index:10; margin-top:4px; padding:6px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); display:flex; flex-direction:column; gap:4px; min-width:200px;">
                <button class="btn" type="button" id="reportIssueBtn" style="width:100%; text-align:left;">
                  Report Issue
                </button>
                <button class="btn" type="button" id="feedbackBtn" style="width:100%; text-align:left;">
                  Provide Feedback
                </button>
              </div>
            </details>

            <a class="btn secondary" href="index.html">Back to search</a>
          </div>
        </article>
      `;

      const base = window.location.origin +
        window.location.pathname.replace(/[^/]*$/, '');
      const resourceUrl  = base + 'resource.html?id=' + encodeURIComponent(item.id);
      const mapsUrl = 'https://www.google.com/maps/search/' +
        encodeURIComponent(item.name + ' ' + item.building +
                           ' Colorado State University');

      const shareResourceBtn = document.getElementById('shareResourceBtn');
      const shareLocationBtn = document.getElementById('shareLocationBtn');
      if (shareResourceBtn) {
        shareResourceBtn.addEventListener('click', () =>
          copyLinkToClipboard(resourceUrl, 'Resource link copied to clipboard.')
        );
      }
      if (shareLocationBtn) {
        shareLocationBtn.addEventListener('click', () =>
          copyLinkToClipboard(mapsUrl, 'Directions link copied to clipboard.')
        );
      }

      const favBtn = document.getElementById('favBtn');
      if (favBtn){
        favBtn.addEventListener('click', () => {
          const sess = AUTH.current();
          if (!sess) { window.location.href = 'login.html'; return; }
          const nowFav = FAVS.toggle(sess.email, item.id);
          const fav = nowFav.includes(String(item.id));
          favBtn.setAttribute('aria-pressed', fav ? 'true' : 'false');
          favBtn.textContent = fav ? '‚òÖ Favorited' : '‚òÜ Favorite';
        });
      }

      const reportIssueBtn = document.getElementById('reportIssueBtn');
      const feedbackBtn    = document.getElementById('feedbackBtn');

      function openMail(kind){
        const to = 'ram-finder-admin@colostate.edu';
        const subject = `${kind}: ${item.name}`;
        const bodyLines = [
          'Hi RamFinder team,',
          '',
          `${kind} with this resource:`,
          `- Name: ${item.name}`,
          `- Building: ${item.building}`,
          item.room ? `- Room: ${item.room}` : '',
          '',
          'Details:',
          '',
          '',
        ].filter(Boolean);
        const body = encodeURIComponent(bodyLines.join('\n'));
        const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${body}`;
        window.location.href = mailto;
      }

      if (reportIssueBtn) {
        reportIssueBtn.addEventListener('click', () => openMail('Issue'));
      }
      if (feedbackBtn) {
        feedbackBtn.addEventListener('click', () => openMail('Feedback'));
      }
    }

    init();
  </script>
</body>
</html>
