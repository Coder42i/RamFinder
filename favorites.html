<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Favorites • RamFinder</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">RF</div>
      <div>
        <h1>My Favorites</h1>
        <div class="subtitle">Quick access to your saved resources.</div>
        <nav class="breadcrumb"><a href="index.html">Home</a> › <span>Favorites</span></nav>
      </div>
      <div id="userbox" class="badge"></div>
      <a id="favLink" class="btn" href="favorites.html" style="width:auto;">Favorites</a>
      <a id="loginLink" class="btn" href="login.html" style="width:auto; display:none">Log in</a>
      <button id="logoutBtn" class="btn" style="width:auto; display:none">Log out</button>
      <a id="adminLink" class="btn" href="admin.html" style="width:auto; display:none">Admin</a>
    </header>

    <section class="results" id="favList" aria-label="Favorites"></section>
    <div id="empty" class="empty" hidden>You don’t have any favorites yet.</div>

    <footer>
      <div>Sign in on the main page to add favorites.</div>
    </footer>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/favs.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    const DATA_URL = 'data/resources.json';
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    (function initHeader(){
      const sess = AUTH.current();
      const userbox   = document.getElementById('userbox');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const adminLink = document.getElementById('adminLink');
      const favLink   = document.getElementById('favLink');

      if (sess) {
        userbox.textContent = (sess.admin ? 'Admin • ' : '') + (sess.email || '');
        loginLink.style.display = 'none';
        logoutBtn.style.display  = 'inline-block';
        favLink.style.display    = 'inline-block';
        logoutBtn.addEventListener('click', () => {
          AUTH.logout();
          window.location.href = 'index.html';
        });
        if (sess.admin && adminLink) adminLink.style.display = 'inline-block';
        else if (adminLink) adminLink.style.display = 'none';
      } else {
        userbox.textContent = 'Guest';
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display  = 'none';
        favLink.style.display    = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    })();

    function isOpenNow(item, now=new Date()){
      if (!item.hours) return false;
      const slot = item.hours[DOW[now.getDay()]];
      if (!slot || slot.closed) return false;
      const [oh,om] = (slot.open||'00:00').split(':').map(Number);
      const [ch,cm] = (slot.close||'00:00').split(':').map(Number);
      const cur = now.getHours()*60 + now.getMinutes();
      const openM = oh*60+om, closeM = ch*60+cm;
      return cur >= openM && cur <= closeM;
    }

    function esc(s){ return (s ?? '').toString()
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    async function initFavs(){
      const listEl = document.getElementById('favList');
      const empty  = document.getElementById('empty');
      const sess   = AUTH.current();
      if (!sess){
        empty.hidden = false;
        listEl.innerHTML = '<p>Please log in on the main page to manage favorites.</p>';
        return;
      }

      const res = await fetch(DATA_URL, {cache:'no-store'});
      const data = await res.json();
      const favIds = FAVS.all(sess.email).map(String);

      const list = data.filter(r => favIds.includes(String(r.id)))
                       .sort((a,b) => (a.name||'').localeCompare(b.name||''));

      if (!list.length){
        empty.hidden = false;
        listEl.innerHTML = '';
        return;
      }
      empty.hidden = true;

      listEl.innerHTML = '';
      for (const r of list){
        const open = isOpenNow(r);
        const out  = !!r.out_of_service;
        const statusClass = out ? 'closed' : (open ? 'open' : 'closed');
        const statusText  = out ? 'Out of Service' : (open ? 'Open Now' : 'Closed');

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="badge">${esc(r.type || 'Resource')}</div>
          <div class="name">
            <a href="resource.html?id=${encodeURIComponent(r.id)}"
               style="color:inherit;text-decoration:none">
              ${esc(r.name)}
            </a>
          </div>
          <div class="row">
            <span class="dot"></span>
            <span>${esc(r.building)}${r.room ? ', '+esc(r.room) : ''}</span>
          </div>
          <div class="row">
            <strong class="${statusClass}">${statusText}</strong>
          </div>
          ${r.accessibility
            ? `<div class="row"><span>♿ ${esc(r.accessibility)}</span></div>`
            : ''}
          <div class="actions">
            <a class="btn" href="resource.html?id=${encodeURIComponent(r.id)}">
              Details
            </a>
            <button class="btn" data-id="${r.id}">Remove</button>
          </div>
        `;
        listEl.appendChild(card);
      }

      listEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-id]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const nowFav = FAVS.toggle(sess.email, id);
        const still = nowFav.includes(String(id));
        if (!still){
          btn.closest('.card').remove();
          if (!listEl.querySelector('.card')){
            empty.hidden = false;
          }
        }
      });
    }

    initFavs();
  </script>
</body>
</html>
