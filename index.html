<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RamFinder ‚Ä¢ Search</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">RF</div>
      <div>
        <h1>RamFinder ‚Äì Campus Resources</h1>
        <div class="subtitle">
          Search resources, see what‚Äôs open now, get directions, and save favorites.
        </div>
        <nav class="breadcrumb"><a href="index.html">Home</a></nav>
      </div>
      <div id="userbox" class="badge">Guest</div>
      <a id="favLink" class="btn" href="favorites.html" style="display:none">Favorites</a>
      <a id="loginLink" class="btn" href="login.html">Log in</a>
      <button id="logoutBtn" class="btn" style="display:none">Log out</button>
      <a id="adminLink" class="btn" href="admin.html" style="display:none">Admin</a>
    </header>

    <section aria-label="Search tools">
      <div class="searchbar" role="search">
        <input id="q" type="search"
               placeholder="Search by name, type, or building (e.g., printer, vending, Morgan)"
               aria-label="Search resources" autofocus />
        <button id="clearBtn" aria-label="Clear search">Clear</button>
      </div>

      <div class="controls">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
          <label class="toggle"><input id="openNow" type="checkbox" /> Open Now</label>
          <label class="toggle">
            <input id="groupedToggle" type="checkbox" checked />
            Show results in separate groups
          </label>
        </div>
        <div id="chips" class="chips" aria-label="Quick filters"></div>
      </div>
    </section>

    <div class="meta" aria-live="polite" aria-atomic="true">
      <span id="count">0 results</span>
      <span>‚Ä¢</span>
      <span>Type <code class="kbd">/</code> to focus, <code class="kbd">Esc</code> to clear</span>
    </div>

    <section class="results" id="results" aria-label="Search results"></section>
    <div id="accordion" class="group-accordion" aria-label="Grouped results"></div>

    <div id="empty" class="empty" hidden>No resources match your search.</div>

    <footer>
      <div>Tip: Click a category to expand it. Sign in to save favorites.</div>

      <form id="updatesForm" class="updates-form" novalidate
            style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
        <label for="updatesEmail" class="sr-only">Email for updates</label>
        <input id="updatesEmail"
               type="email"
               placeholder="you@colostate.edu"
               required
               style="min-width:220px;" />
        <button class="btn secondary" type="submit">Get updates</button>
        <span id="updatesStatus" class="meta" aria-live="polite"></span>
      </form>
    </footer>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/favs.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    (function initHeader(){
      const sess      = AUTH.current();
      const userbox   = document.getElementById('userbox');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const adminLink = document.getElementById('adminLink');
      const favLink   = document.getElementById('favLink');

      if (sess) {
        userbox.textContent = (sess.admin ? 'Admin ‚Ä¢ ' : '') + (sess.email || '');
        loginLink.style.display = 'none';
        logoutBtn.style.display  = 'inline-block';
        favLink.style.display    = 'inline-block';
        logoutBtn.addEventListener('click', () => {
          AUTH.logout();
          window.location.href = 'index.html';
        });
        if (sess.admin && adminLink) adminLink.style.display = 'inline-block';
        else if (adminLink) adminLink.style.display = 'none';
      } else {
        userbox.textContent = 'Guest';
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display  = 'none';
        favLink.style.display    = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    })();
  </script>

  <script>
    const API_BASE = 'http://127.0.0.1:5050';
    const DATA_URL = 'data/resources.json';
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    const norm = (s) => (s||'').toString().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const slug = (s) => norm(s).replace(/[^a-z0-9]+/g,'');
    const titleCase = (s) => {
      const t = (s||'').toString().trim();
      if (!t) return 'Other';
      return t.replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1));
    };

    function escapeHtml(str){
      return (str+"").replace(/&/g,'&amp;')
                     .replace(/</g,'&lt;')
                     .replace(/>/g,'&gt;');
    }
    function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');}
    function highlight(text, query){
      const t = text ?? '';
      const qn = norm(query).trim();
      if(!qn) return escapeHtml(t);
      const re = new RegExp('(' + escapeRegExp(qn) + ')', 'ig');
      return escapeHtml(t).replace(re, '<mark>$1</mark>');
    }
    function isOpenNow(item, now=new Date()){
      const slot = item.hours?.[DOW[now.getDay()]];
      if(!slot || slot.closed) return false;
      const [oh, om] = (slot.open||'00:00').split(':').map(Number);
      const [ch, cm] = (slot.close||'00:00').split(':').map(Number);
      const openM = oh*60+om, closeM = ch*60+cm;
      const curM  = now.getHours()*60+now.getMinutes();
      return curM>=openM && curM<=closeM;
    }

    let DATA=[]; 
    let activeChip=null;
    let expandedGroup=null;

    const q             = document.getElementById('q');
    const results       = document.getElementById('results');
    const accordion     = document.getElementById('accordion');
    const count         = document.getElementById('count');
    const empty         = document.getElementById('empty');
    const clearBtn      = document.getElementById('clearBtn');
    const openNow       = document.getElementById('openNow');
    const chipsWrap     = document.getElementById('chips');
    const groupedToggle = document.getElementById('groupedToggle');

    const typeMap = new Map();
    function labelFor(sl){ return typeMap.get(sl) || titleCase(sl); }
    function safeGroupedOn(){ return groupedToggle ? !!groupedToggle.checked : true; }

    function buildTypeMap(){
      typeMap.clear();
      for(const r of DATA){
        const sl = slug(r.type || 'other');
        if(!typeMap.has(sl)){
          const lbl = r.type ? r.type : 'Other';
          typeMap.set(sl, titleCase(lbl));
        }
      }
    }

    function buildChips(){
      const ORDER = ['printer','medical','hospital','study','lab','restroom',
                     'vending','bikerack','other'];
      const present = Array.from(typeMap.keys());
      const ordered = [
        ...ORDER.filter(k => present.includes(k)),
        ...present.filter(k => !ORDER.includes(k))
                 .sort((a,b)=> labelFor(a).localeCompare(
                      labelFor(b), undefined, {sensitivity:'base'}))
      ];

      chipsWrap.innerHTML = ordered.map(k => 
        `<button class="chip" data-chip="${k}"
                 aria-pressed="${activeChip===k?'true':'false'}">
           ${escapeHtml(labelFor(k))}
         </button>`
      ).join('');

      chipsWrap.querySelectorAll('.chip').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const val     = btn.dataset.chip;
          const pressed = btn.getAttribute('aria-pressed')==='true';
          chipsWrap.querySelectorAll('.chip')
            .forEach(c=>c.setAttribute('aria-pressed','false'));
          if(!pressed){
            btn.setAttribute('aria-pressed','true');
            activeChip   = val;
            expandedGroup= val;
          } else {
            activeChip   = null;
            expandedGroup= null;
          }
          doSearch();
        });
      });
    }

    function filterData(query){
      const nq=norm(query);
      return DATA.filter(item=>{
        const hay=[item.name,item.type,item.building,item.room,
                   item.notes,item.accessibility]
                   .map(norm).join(' ');
        const chipOk = activeChip ? slug(item.type)===activeChip : true;
        const openOk = openNow.checked ? isOpenNow(item) : true;
        return chipOk && openOk && (nq==='' || hay.includes(nq));
      });
    }

    function favButtonHTML(signedIn, isFav, id){
      const label    = isFav ? '‚òÖ Favorited' : '‚òÜ Favorite';
      const pressed  = isFav ? 'true' : 'false';
      const disabled = signedIn ? '' :
        'disabled title="Log in to use favorites"';
      return `<button class="btn" data-action="fav"
                      data-id="${id}" aria-pressed="${pressed}"
                      ${disabled}>${label}</button>`;
    }

    async function copyLinkToClipboard(url, message){
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          alert(message || 'Link copied to clipboard.');
        } else {
          window.prompt('Copy this link:', url);
        }
      } catch (e) {
        console.error('Copy failed', e);
        window.prompt('Copy this link:', url);
      }
    }

    function cardHTML(r, query, sess){
      const open = isOpenNow(r);
      const out  = !!r.out_of_service;
      const statusClass = out ? 'closed' : (open ? 'open' : 'closed');
      const statusText  = out ? 'Out of Service' : (open ? 'Open Now' : 'Closed');
      const isFav = !!(sess && FAVS.has(sess.email, r.id));
      const lbl   = labelFor(slug(r.type || 'other'));
      return `
        <article class="card">
          <div class="badge">${escapeHtml(lbl)}</div>
          <div class="name">
            <a href="resource.html?id=${encodeURIComponent(r.id)}"
               style="color:inherit;text-decoration:none">
              ${highlight(r.name,query)}
            </a>
          </div>
          <div class="row">
            <span class="dot"></span>
            <span>${highlight(r.building+(r.room?', '+r.room:''),query)}</span>
          </div>
          <div class="row">
            <strong class="${statusClass}">${statusText}</strong>
          </div>
          ${r.accessibility
            ? `<div class="row"><span>‚ôø ${highlight(r.accessibility, query)}</span></div>`
            : ''}
          <div class="actions">
            <a class="btn" href="resource.html?id=${encodeURIComponent(r.id)}">
              Details
            </a>
            <a class="btn"
               href="https://www.google.com/maps/search/${
                 encodeURIComponent(r.name+' '+r.building+
                   ' Colorado State University')
               }"
               target="_blank">
              Directions
            </a>

            <button class="btn icon-btn" type="button"
                    data-action="share-resource" data-id="${r.id}"
                    title="Copy link to this resource"
                    aria-label="Copy link to this resource">üîó</button>

            <button class="btn icon-btn" type="button"
                    data-action="share-location" data-id="${r.id}"
                    title="Copy directions link"
                    aria-label="Copy directions link">üìç</button>

            ${favButtonHTML(!!sess, isFav, r.id)}
          </div>
        </article>`;
    }

    function clearViews(){
      results.innerHTML   = '';
      accordion.innerHTML = '';
    }
    function setMode(grouped){
      expandedGroup = null;
      activeChip    = null;
      buildChips();
      clearViews();
      results.hidden   = grouped;
      accordion.hidden = !grouped;
      render(filterData(q.value.trim()), q.value.trim());
    }

    function renderFlat(list, query){
      const sess = AUTH.current();
      results.hidden   = false;
      accordion.hidden = true;
      chipsWrap.style.display = '';
      results.classList.remove('grouped');
      results.innerHTML='';
      if(!list.length){
        count.textContent='0 results';
        results.hidden=true;
        empty.hidden=false;
        return;
      }
      results.hidden=false;
      empty.hidden=true;
      count.textContent=`${list.length} result${list.length>1?'s':''}`;
      results.innerHTML = list.map(r=>cardHTML(r,query,sess)).join('');
    }

    function renderAccordion(list, query){
      const sess = AUTH.current();
      results.hidden   = true;
      accordion.hidden = false;
      chipsWrap.style.display = expandedGroup ? '' : 'none';

      const groups = new Map();
      for (const r of list){
        const key = slug(r.type || 'other');
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      }

      const ORDER = ['printer','medical','hospital','study','lab',
                     'restroom','vending','bikerack','other'];
      const present = Array.from(groups.keys());
      const ordered = [
        ...ORDER.filter(k => present.includes(k)),
        ...present.filter(k => !ORDER.includes(k))
                 .sort((a,b)=> labelFor(a).localeCompare(
                      labelFor(b), undefined, {sensitivity:'base'}))
      ];

      const total      = list.length;
      const groupCount = ordered.length;
      if(!total){
        count.textContent='0 results';
        accordion.innerHTML='';
        empty.hidden=false;
        return;
      }
      empty.hidden=true;
      count.textContent =
        `${total} result${total>1?'s':''} ‚Ä¢ ${groupCount} categor` +
        `${groupCount>1?'ies':'y'}`;

      accordion.innerHTML = ordered.map(key=>{
        const items = groups.get(key).slice()
          .sort((a,b)=> a.name.localeCompare(b.name));
        const open = expandedGroup === key;
        return `
          <section class="acc-section" data-key="${key}">
            <button class="acc-header" type="button"
                    aria-expanded="${open?'true':'false'}">
              <span class="acc-title">${escapeHtml(labelFor(key))}</span>
              <span class="acc-count">${items.length}</span>
              <span class="acc-caret" aria-hidden="true">‚ñæ</span>
            </button>
            <div class="acc-panel" ${open?'':'hidden'}>
              <div class="results group-grid">
                ${items.map(r=>cardHTML(r,query,sess)).join('')}
              </div>
            </div>
          </section>`;
      }).join('');

      accordion.querySelectorAll('.acc-header').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const sec = btn.closest('.acc-section');
          const key = sec.getAttribute('data-key');
          if (expandedGroup === key){
            expandedGroup = null;
            activeChip    = null;
            buildChips();
            renderAccordion(filterData(q.value.trim()), q.value.trim());
            return;
          }
          expandedGroup = key;
          activeChip    = key;
          buildChips();
          renderAccordion(filterData(q.value.trim()), q.value.trim());
          sec.scrollIntoView({behavior:'smooth', block:'start'});
        });
      });
    }

    function render(list,query){
      clearViews();
      try{
        if (safeGroupedOn()) renderAccordion(list, query);
        else renderFlat(list, query);
      }catch(err){
        console.error('Render error, falling back to flat:', err);
        renderFlat(list, query);
      }
    }

    function debounce(fn,ms=120){
      let t;
      return(...a)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...a),ms);
      };
    }
    const doSearch=debounce(()=>{
      render(filterData(q.value.trim()),q.value.trim());
    });

    q.addEventListener('input',doSearch);
    clearBtn.addEventListener('click',()=>{
      q.value='';
      q.focus();
      setMode(safeGroupedOn());
    });
    window.addEventListener('keydown',e=>{
      if(e.key==='/'&&document.activeElement!==q){
        e.preventDefault();
        q.focus();
      }
      if(e.key==='Escape'){
        q.value='';
        setMode(safeGroupedOn());
        q.blur();
      }
    });
    if (groupedToggle)
      groupedToggle.addEventListener('change', ()=>{
        setMode(groupedToggle.checked);
      });
    openNow.addEventListener('change', ()=> doSearch());

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.getAttribute('data-action');
      const id     = btn.getAttribute('data-id');

      if (action === 'fav') {
        const sess = AUTH.current();
        if (!sess) { window.location.href = 'login.html'; return; }
        const nowFav = FAVS.toggle(sess.email, id);
        const isFav  = nowFav.includes(String(id));
        btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
        btn.textContent = isFav ? '‚òÖ Favorited' : '‚òÜ Favorite';
        return;
      }

      if (action === 'share-resource') {
        const base = window.location.origin +
          window.location.pathname.replace(/[^/]*$/, '');
        const url  = base + 'resource.html?id=' + encodeURIComponent(id);
        copyLinkToClipboard(url, 'Resource link copied to clipboard.');
        return;
      }

      if (action === 'share-location') {
        const res = DATA.find(r => String(r.id) === String(id));
        if (!res) return;
        const mapsUrl = 'https://www.google.com/maps/search/' +
          encodeURIComponent(res.name + ' ' + res.building +
                             ' Colorado State University');
        copyLinkToClipboard(mapsUrl, 'Directions link copied to clipboard.');
        return;
      }
    });

    async function init(){
      const res = await fetch(DATA_URL,{cache:'no-store'});
      DATA      = await res.json();
      buildTypeMap();
      buildChips();
      setMode(true);
    }
    init();

    // --- "Get updates" subscription form wiring ---
    const updatesForm   = document.getElementById('updatesForm');
    const updatesEmail  = document.getElementById('updatesEmail');
    const updatesStatus = document.getElementById('updatesStatus');

    if (updatesForm && updatesEmail && updatesStatus) {
      updatesForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = (updatesEmail.value || '').trim();

        if (!email) {
          updatesStatus.textContent = 'Please enter an email address.';
          return;
        }

        updatesStatus.textContent = 'Saving...';

        try {
          const res = await fetch(`${API_BASE}/api/updates/subscribe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          let data = {};
          try { data = await res.json(); } catch {}

          if (!res.ok || data.error) {
            updatesStatus.textContent =
              data.error || 'Could not save your subscription. Please try again.';
            return;
          }

          updatesStatus.textContent =
            'Thanks! You will receive updates about RamFinder.';
          updatesForm.reset();
        } catch (err) {
          console.error(err);
          updatesStatus.textContent =
            'Server not reachable right now. Please try again later.';
        }
      });
    }
  </script>
</body>
</html>
