<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RamFinder â€¢ Search</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="container">

<header class="app-header">
  <div class="brand-block">
    <div class="logo" aria-hidden="true">RF</div>
    <div class="brand-text">
      <h1>RamFinder â€“ Campus Resources</h1>
      <div class="subtitle">Search resources, see whatâ€™s open now, get directions, and save favorites.</div>
      <nav class="breadcrumb"><a href="index.html">Home</a></nav>
    </div>
  </div>

  <div class="header-actions">
    <div id="userbox" class="badge">Guest</div>
    <button id="themeToggle" class="btn secondary icon-btn" type="button" title="Switch to dark mode">ðŸŒ™</button>
    <a id="favLink" class="btn" href="favorites.html" style="display:none">Favorites</a>
    <a id="loginLink" class="btn" href="login.html">Log in</a>
    <button id="logoutBtn" class="btn" style="display:none">Log out</button>
    <a id="adminLink" class="btn" href="admin.html" style="display:none">Admin</a>
  </div>
</header>

    <section aria-label="Search tools">
      <div class="searchbar" role="search">
        <input id="q" type="search" placeholder="Search by name, type, or building (e.g., printer, vending, Morgan)" aria-label="Search resources" autofocus />
        <button id="clearBtn" aria-label="Clear search">Clear</button>
      </div>

      <div class="controls">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
          <label class="toggle"><input id="openNow" type="checkbox" /> Open Now</label>
          <label class="toggle"><input id="groupedToggle" type="checkbox" checked /> Show results in separate groups</label>
        </div>
        <!-- Chips are generated dynamically; show only when a group is expanded -->
        <div id="chips" class="chips" aria-label="Quick filters"></div>
      </div>
    </section>

    <div class="meta" aria-live="polite" aria-atomic="true">
      <span id="count">0 results</span>
      <span>â€¢</span>
      <span>Type <code class="kbd">/</code> to focus, <code class="kbd">Esc</code> to clear</span>
    </div>

    <!-- Flat mode container -->
    <section class="results" id="results" aria-label="Search results"></section>
    <!-- Grouped mode container -->
    <div id="accordion" class="group-accordion" aria-label="Grouped results"></div>

    <div id="empty" class="empty" hidden>No resources match your search.</div>

    <footer>
      <div>Tip: Click a category to expand it. Sign in to save favorites.</div>
    </footer>
  </div>

  <!-- Page scripts -->
  <script src="assets/store.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/favs.js"></script>

  <!-- Header session controller -->
  <script>
    (async function initHeader(){
      const sess = AUTH.current();
      const userbox   = document.getElementById('userbox');
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const adminLink = document.getElementById('adminLink');
      const favLink   = document.getElementById('favLink');

      if (sess) {
        userbox.textContent = (sess.admin ? 'Admin â€¢ ' : '') + (sess.email || '');
        loginLink.style.display = 'none';
        logoutBtn.style.display  = 'inline-block';
        favLink.style.display    = 'inline-block';
        logoutBtn.addEventListener('click', () => {
          AUTH.logout();
          window.location.href = 'index.html';
        });
        if (sess.admin && adminLink) adminLink.style.display = 'inline-block';
        else if (adminLink) adminLink.style.display = 'none';
      } else {
        userbox.textContent = 'Guest';
        loginLink.style.display = 'inline-block';
        logoutBtn.style.display  = 'none';
        favLink.style.display    = 'none';
        if (adminLink) adminLink.style.display = 'none';
      }
    })();
  </script>

  <!-- Search + Favorites logic with dynamic chips & accordion groups -->
  <script>
    const DATA_URL = 'data/resources.json';
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    // Normalizers
    const norm = (s) => (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const slug = (s) => norm(s).replace(/[^a-z0-9]+/g,''); // "Bike Rack" -> "bikerack"
    const titleCase = (s) => {
      const t = (s||'').toString().trim();
      if (!t) return 'Other';
      return t.replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1));
    };

    function escapeHtml(str){return (str+"").replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');}
    function highlight(text, query){
      const t = text ?? ''; const qn = norm(query).trim();
      if(!qn) return escapeHtml(t);
      const re = new RegExp('(' + escapeRegExp(qn) + ')', 'ig');
      return escapeHtml(t).replace(re, '<mark>$1</mark>');
    }
    function isOpenNow(item, now=new Date()){
      const slot = item.hours?.[DOW[now.getDay()]];
      if(!slot || slot.closed) return false;
      const [oh, om] = (slot.open||'00:00').split(':').map(Number);
      const [ch, cm] = (slot.close||'00:00').split(':').map(Number);
      const openM = oh*60+om, closeM = ch*60+cm, curM = now.getHours()*60+now.getMinutes();
      return curM>=openM && curM<=closeM;
    }

    // State
    let DATA=[]; 
    let activeChip=null;     // category slug when a chip is selected
    let expandedGroup=null;  // category slug when a group is expanded (accordion)
    const q=document.getElementById('q'), results=document.getElementById('results'), accordion=document.getElementById('accordion'),
          count=document.getElementById('count'), empty=document.getElementById('empty'),
          clearBtn=document.getElementById('clearBtn'), openNow=document.getElementById('openNow'),
          chipsWrap=document.getElementById('chips'), groupedToggle=document.getElementById('groupedToggle');

    const typeMap = new Map(); // slug -> display label
    function labelFor(sl){ return typeMap.get(sl) || titleCase(sl); }
    function safeGroupedOn(){ return groupedToggle ? !!groupedToggle.checked : true; }

    function buildTypeMap(){
      typeMap.clear();
      for(const r of DATA){
        const sl = slug(r.type || 'other');
        if(!typeMap.has(sl)){
          const lbl = r.type ? r.type : 'Other';
          typeMap.set(sl, titleCase(lbl));
        }
      }
    }

    function buildChips(){
      // Chips represent categories; we show/hide based on accordion state.
      const ORDER = ['printer','medical','hospital','study','lab','restroom','vending','bikerack','other'];
      const present = Array.from(typeMap.keys());
      const ordered = [
        ...ORDER.filter(k => present.includes(k)),
        ...present.filter(k => !ORDER.includes(k)).sort((a,b)=> labelFor(a).localeCompare(labelFor(b), undefined, {sensitivity:'base'}))
      ];

      chipsWrap.innerHTML = ordered.map(k => 
        `<button class="chip" data-chip="${k}" aria-pressed="${activeChip===k?'true':'false'}">${escapeHtml(labelFor(k))}</button>`
      ).join('');

      chipsWrap.querySelectorAll('.chip').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const val=btn.dataset.chip;
          const pressed=btn.getAttribute('aria-pressed')==='true';
          chipsWrap.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
          if(!pressed){ btn.setAttribute('aria-pressed','true'); activeChip=val; expandedGroup=val; }
          else { activeChip=null; expandedGroup=null; }
          doSearch(); // will render accordion with only that group expanded
        });
      });
    }

    function filterData(query){
      const nq=norm(query);
      return DATA.filter(item=>{
        const hay=[item.name,item.type,item.building,item.room,item.notes].map(norm).join(' ');
        const chipOk=activeChip ? slug(item.type)===activeChip : true;
        const openOk=openNow.checked?isOpenNow(item):true;
        return chipOk&&openOk&&(nq===''||hay.includes(nq));
      });
    }

    function favButtonHTML(signedIn, isFav, id){
      const label = isFav ? 'â˜… Favorited' : 'â˜† Favorite';
      const pressed = isFav ? 'true' : 'false';
      const disabled = signedIn ? '' : 'disabled title="Log in to use favorites"';
      return `<button class="btn" data-action="fav" data-id="${id}" aria-pressed="${pressed}" ${disabled}>${label}</button>`;
    }

    function cardHTML(r, query, sess){
      const open=isOpenNow(r);
      const isFav = !!(sess && FAVS.has(sess.email, r.id));
      const lbl = labelFor(slug(r.type || 'other'));
      return `
        <article class="card">
          <div class="badge">${escapeHtml(lbl)}</div>
          <div class="name"><a href="resource.html?id=${encodeURIComponent(r.id)}" style="color:inherit;text-decoration:none">${highlight(r.name,query)}</a></div>
          <div class="row"><span class="dot"></span><span>${highlight(r.building+(r.room?', '+r.room:''),query)}</span></div>
          <div class="row"><strong class="${open?'open':'closed'}">${open?'Open Now':'Closed'}</strong></div>
          <div class="actions">
            <a class="btn" href="resource.html?id=${encodeURIComponent(r.id)}">Details</a>
            <a class="btn" href="https://www.google.com/maps/search/${encodeURIComponent(r.name+' '+r.building+' Colorado State University')}" target="_blank">Directions</a>
            ${favButtonHTML(!!sess, isFav, r.id)}
          </div>
        </article>`;
    }

    // Helpers to avoid stale DOM when switching modes
    function clearViews(){
      results.innerHTML = '';
      accordion.innerHTML = '';
    }
    function setMode(grouped){
      // Reset state & views
      expandedGroup = null;
      activeChip = null;
      buildChips();
      clearViews();
      // Ensure containers visibility matches mode
      results.hidden = grouped;
      accordion.hidden = !grouped;
      // Render fresh
      render(filterData(q.value.trim()), q.value.trim());
    }

    // Flat render (original grid)
    function renderFlat(list, query){
      const sess = AUTH.current();
      results.hidden = false;
      accordion.hidden = true;
      chipsWrap.style.display = ''; // chips visible in flat mode
      results.classList.remove('grouped');
      results.innerHTML='';
      if(!list.length){count.textContent='0 results';results.hidden=true;empty.hidden=false;return;}
      results.hidden=false;empty.hidden=true;count.textContent=`${list.length} result${list.length>1?'s':''}`;
      results.innerHTML = list.map(r=>cardHTML(r,query,sess)).join('');
    }

    // Accordion render (grouped)
    function renderAccordion(list, query){
      const sess = AUTH.current();
      results.hidden = true;
      accordion.hidden = false;
      chipsWrap.style.display = expandedGroup ? '' : 'none'; // hide chips until a group is open

      // Build groups
      const groups = new Map();
      for (const r of list){
        const key = slug(r.type || 'other');
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      }

      // Order keys
      const ORDER = ['printer','medical','hospital','study','lab','restroom','vending','bikerack','other'];
      const present = Array.from(groups.keys());
      const ordered = [
        ...ORDER.filter(k => present.includes(k)),
        ...present.filter(k => !ORDER.includes(k)).sort((a,b)=> labelFor(a).localeCompare(labelFor(b), undefined, {sensitivity:'base'}))
      ];

      // Count summary
      const total = list.length;
      const groupCount = ordered.length;
      if(!total){count.textContent='0 results';accordion.innerHTML='';empty.hidden=false;return;}
      empty.hidden=true;
      count.textContent = `${total} result${total>1?'s':''} â€¢ ${groupCount} categor${groupCount>1?'ies':'y'}`;

      // Render accordion
      accordion.innerHTML = ordered.map(key=>{
        const items = groups.get(key).slice().sort((a,b)=> a.name.localeCompare(b.name));
        const open = expandedGroup === key;
        return `
          <section class="acc-section" data-key="${key}">
            <button class="acc-header" type="button" aria-expanded="${open?'true':'false'}">
              <span class="acc-title">${escapeHtml(labelFor(key))}</span>
              <span class="acc-count">${items.length}</span>
              <span class="acc-caret" aria-hidden="true">â–¾</span>
            </button>
            <div class="acc-panel" ${open?'':'hidden'}>
              <div class="results group-grid">
                ${items.map(r=>cardHTML(r,query,sess)).join('')}
              </div>
            </div>
          </section>`;
      }).join('');

      // Wire header clicks (accordion behavior)
      accordion.querySelectorAll('.acc-header').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const sec = btn.closest('.acc-section');
          const key = sec.getAttribute('data-key');
          if (expandedGroup === key){
            // collapse all
            expandedGroup = null;
            activeChip = null;
            buildChips();
            renderAccordion(filterData(q.value.trim()), q.value.trim());
            return;
          }
          // expand this, collapse others
          expandedGroup = key;
          activeChip = key;
          buildChips();
          renderAccordion(filterData(q.value.trim()), q.value.trim());
          sec.scrollIntoView({behavior:'smooth', block:'start'});
        });
      });
    }

    function render(list,query){
      clearViews(); // ensure we never leave stale content behind
      try{
        if (safeGroupedOn()) renderAccordion(list, query);
        else renderFlat(list, query);
      }catch(err){
        console.error('Render error, falling back to flat:', err);
        renderFlat(list, query);
      }
    }

    function debounce(fn,ms=120){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
    const doSearch=debounce(()=>{render(filterData(q.value.trim()),q.value.trim());});

    // Events
    q.addEventListener('input',doSearch);
    clearBtn.addEventListener('click',()=>{
      q.value=''; q.focus();
      setMode(safeGroupedOn()); // resets states and re-renders in current mode
    });
    window.addEventListener('keydown',e=>{
      if(e.key==='/'&&document.activeElement!==q){e.preventDefault();q.focus();}
      if(e.key==='Escape'){ q.value=''; setMode(safeGroupedOn()); q.blur(); }
    });
    if (groupedToggle) groupedToggle.addEventListener('change', ()=>{
      setMode(groupedToggle.checked);
    });
    openNow.addEventListener('change', ()=> doSearch());

    // Favorites (delegated; works in both modes)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action="fav"]');
      if (!btn) return;
      const sess = AUTH.current();
      if (!sess) { window.location.href = 'login.html'; return; }
      const id = btn.getAttribute('data-id');
      const nowFav = FAVS.toggle(sess.email, id);
      const isFav = nowFav.includes(String(id));
      btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
      btn.textContent = isFav ? 'â˜… Favorited' : 'â˜† Favorite';
    });

    // Init
    async function init(){
      const res=await fetch(DATA_URL,{cache:'no-store'});
      DATA=await res.json();
      buildTypeMap();
      buildChips();
      setMode(true); // start grouped by default
    }
    init();
  </script>

  <!-- THEME INLINE -->
  <script>
    (function(){
      const KEY = 'rf:theme';
      const ROOT = document.documentElement;
      const btn  = document.getElementById('themeToggle');

      function apply(theme){
        const t = (theme === 'dark') ? 'dark' : 'light';
        ROOT.setAttribute('data-theme', t);
        localStorage.setItem(KEY, t);
        if (btn){
          const dark = t === 'dark';
          btn.setAttribute('aria-pressed', dark ? 'true' : 'false');
          btn.title = dark ? 'Switch to light mode' : 'Switch to dark mode';
          btn.textContent = dark ? 'â˜€ï¸' : 'ðŸŒ™';
        }
      }
      apply((localStorage.getItem(KEY) || 'light').toLowerCase());
      if (btn) btn.addEventListener('click', () => apply(ROOT.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
    })();
  </script>
</body>
</html>
